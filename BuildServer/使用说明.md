# StarForce 本地简易服务器使用说明

## 概述

这是一个简单的TCP游戏服务器，用于与Unity客户端进行网络通信。服务器支持ProtoBuf消息序列化，可以处理客户端连接、心跳包等基本功能。

## 快速开始

### 1. 安装.NET SDK

确保已安装 .NET 8.0 或更高版本：
- 下载地址：https://dotnet.microsoft.com/download
- 验证安装：在命令行运行 `dotnet --version`

### 2. 启动服务器

#### Windows系统
双击运行 `start-server.bat` 文件

#### Linux/macOS系统
```bash
chmod +x start-server.sh
./start-server.sh
```

#### 手动启动
```bash
cd BuildServer
dotnet restore
dotnet build
dotnet run
```

### 3. 配置Unity客户端

确保Unity客户端连接到正确的服务器地址：
- IP地址：`127.0.0.1`（本地）或服务器IP
- 端口：`8000`（默认）

## 服务器功能

### 当前支持的功能

1. **TCP连接管理**
   - 监听客户端连接
   - 管理多个客户端连接
   - 自动处理客户端断开

2. **心跳包处理**
   - 接收客户端心跳包（CSHeartBeat）
   - 发送服务器心跳响应（SCHeartBeat）

3. **消息包序列化**
   - 使用ProtoBuf进行消息序列化/反序列化
   - 支持消息包头和消息包体的处理

## 消息包格式

### 消息包结构

1. **消息包头**：ProtoBuf序列化的 `CSPacketHeader`（客户端）或 `SCPacketHeader`（服务器）
2. **消息包体**：ProtoBuf序列化的消息包，带Fixed32长度前缀

### 支持的消息包

| 消息包 | ID | 方向 | 说明 |
|--------|----|----|----|
| CSHeartBeat | 1 | 客户端→服务器 | 客户端心跳包 |
| SCHeartBeat | 2 | 服务器→客户端 | 服务器心跳响应 |

## 日志输出

服务器运行时会输出以下信息：
- `[HH:mm:ss] 服务器已启动，监听端口: 8000`
- `[HH:mm:ss] 客户端已连接: IP:Port (当前连接数: X)`
- `[HH:mm:ss] 客户端已断开: IP:Port (当前连接数: X)`
- `[HH:mm:ss] 收到未知消息包 ID: X`（如果收到不支持的消息包）

## 自定义端口

### 方法1：命令行参数
```bash
dotnet run -- 8888
```

### 方法2：修改代码
编辑 `Program.cs`，修改默认端口：
```csharp
int port = 8888; // 修改这里
```

## 扩展开发

### 添加新的消息包处理

1. 在 `ClientConnection.cs` 的 `ProcessPacketAsync` 方法中添加新的case：

```csharp
case 100: // 新的消息包ID
    await HandleNewPacketAsync(packetBody);
    break;
```

2. 实现处理函数：

```csharp
private async Task HandleNewPacketAsync(byte[] packetBody)
{
    // 反序列化消息包体
    // 处理业务逻辑
    // 发送响应（如果需要）
}
```

### 添加新的消息包类型

1. 在 `BuildServer` 目录下创建新的消息包类（参考 `SCHeartBeat.cs`）
2. 确保使用ProtoBuf属性标记
3. 在 `ProcessPacketAsync` 中添加处理逻辑

## 故障排除

### 问题1：端口被占用
**错误信息**：`Address already in use` 或 `端口已被占用`

**解决方法**：
- 修改服务器端口
- 或关闭占用端口的程序

### 问题2：客户端无法连接
**可能原因**：
- 防火墙阻止了端口访问
- 服务器未启动
- IP地址或端口配置错误

**解决方法**：
- 检查防火墙设置
- 确认服务器已启动
- 检查Unity客户端的网络配置

### 问题3：消息包解析失败
**可能原因**：
- 消息包格式不匹配
- ProtoBuf序列化问题

**解决方法**：
- 检查消息包定义是否一致
- 查看服务器日志中的错误信息

## 注意事项

1. **消息包大小限制**：单个消息包最大1MB
2. **连接数限制**：当前无限制，可根据需要添加
3. **线程安全**：服务器使用异步处理，支持多客户端并发
4. **资源管理**：服务器会自动清理断开的客户端连接

## 技术栈

- .NET 6.0
- ProtoBuf-net 3.1.25
- TCP Socket

## 相关文档

- [网络模块文档](../docs/详细模块文档/20-网络模块.md)
- [项目模块文档](../docs/项目模块文档.md)

